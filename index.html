<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Song Gift - Custom AI Songs for Any Occasion | EchoGift</title>
    <meta name="description" content="Create the perfect personalized song gift for boyfriend, girlfriend, mom, dad or anyone special. Custom AI-generated songs from $49.99. The unique gift for someone who has everything!">
    <meta name="keywords" content="personalized song, custom song, personalized song gift, custom song gift, personalized song for boyfriend, personalized song for girlfriend, unique Christmas gift, gift for someone who has everything, AI song generator, custom artwork, anniversary song, birthday song">
    <meta name="author" content="EchoGift">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="theme-color" content="#A25524">
    <meta name="google-site-verification" content="dcb1WtIscqkG9GJ7B45Uh7Kqfh5xskpn1O78neMfoc8">
    <link rel="canonical" href="https://echogifts.shop/">
    
    <!-- Geo-targeting and Local SEO -->
    <meta name="geo.region" content="US">
    <meta name="geo.placename" content="United States">
    <meta name="geo.position" content="40.7128;-74.0060">
    <meta name="ICBM" content="40.7128, -74.0060">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://echogifts.shop/">
    <meta property="og:title" content="Personalized Song Gift - Custom AI Songs for Any Occasion | EchoGift">
    <meta property="og:description" content="Create the perfect personalized song gift for boyfriend, girlfriend, mom, dad or anyone special. Custom AI-generated songs from $49.99. The unique gift for someone who has everything!">
    <meta property="og:image" content="https://echogifts.shop/audio/Two%20decades.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="EchoGift - Custom personalized song artwork example">
    <meta property="og:site_name" content="EchoGift">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://echogifts.shop/">
    <meta property="twitter:title" content="Personalized Song Gift - Custom AI Songs for Any Occasion | EchoGift">
    <meta property="twitter:description" content="Create the perfect personalized song gift for boyfriend, girlfriend, mom, dad or anyone special. Custom AI-generated songs from $49.99. The unique gift for someone who has everything!">
    <meta property="twitter:image" content="https://echogifts.shop/audio/Two%20decades.png">
    <meta property="twitter:image:alt" content="EchoGift - Custom personalized song artwork example">
    
    <!-- Additional SEO Meta Tags -->
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EchoGift">
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Google Analytics & Conversion Tracking -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QXKL1J8X23"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      
      gtag('config', 'G-QXKL1J8X23', {
        enhanced_ecommerce: true,
        conversion_linker: true,
        allow_enhanced_conversions: true
      });
      
      gtag('event', 'page_view', {
        page_title: document.title,
        page_location: window.location.href,
        page_path: window.location.pathname
      });
    </script>
    
    <!-- Enhanced Structured Data for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "EchoGift - Personalized AI Song Gifts",
        "description": "Create custom AI-generated songs and albums as unique gifts for birthdays, anniversaries, and special occasions",
        "url": "https://echogifts.shop",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://echogifts.shop/#order?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    
    <style>
        :root {
            --primary-brown: #8B4513;
            --secondary-brown: #D2691E;
            --light-cream: #F5F5DC;
            --accent-brown: #CD853F;
            --white: #FFFFFF;
            --success-green: #10B981;
            --error-red: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #F5F5DC 0%, #FFF8E7 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Mobile-First Design */
        .container {
            width: 100%;
            max-width: 100vw;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-brown), var(--secondary-brown));
            color: white;
            text-align: center;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(139, 69, 19, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 400;
        }

        /* Chat Container - Mobile Optimized */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 90px); /* Account for header */
            position: relative;
        }

        /* Conversation Breadcrumbs - Mobile Friendly */
        .conversation-breadcrumbs {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(245, 245, 220, 0.5);
            border-bottom: 1px solid rgba(139, 69, 19, 0.1);
            font-size: 0.8rem;
            overflow-x: auto;
            white-space: nowrap;
        }

        .breadcrumb-back {
            background: var(--accent-brown);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .breadcrumb-back:hover {
            background: var(--primary-brown);
            transform: translateY(-1px);
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--primary-brown);
            font-weight: 500;
            flex-shrink: 0;
        }

        .breadcrumb-separator {
            color: var(--accent-brown);
            font-weight: 600;
            flex-shrink: 0;
        }

        /* Album Progress - Mobile Optimized */
        .album-progress {
            display: none;
            justify-content: center;
            align-items: center;
            margin: 1rem;
            padding: 0.75rem;
            background: rgba(245, 245, 220, 0.3);
            border-radius: 12px;
            gap: 0.3rem;
            overflow-x: auto;
        }

        .progress-step {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--light-cream);
            border: 2px solid var(--accent-brown);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--accent-brown);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .progress-step.active {
            background: var(--secondary-brown);
            color: white;
            border-color: var(--secondary-brown);
            transform: scale(1.1);
        }

        .progress-step.completed {
            background: var(--success-green);
            color: white;
            border-color: var(--success-green);
        }

        .progress-connector {
            width: 15px;
            height: 2px;
            background: var(--accent-brown);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .progress-connector.completed {
            background: var(--success-green);
        }

        /* Chat Messages - Mobile Optimized */
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; /* iOS smooth scrolling */
        }

        .message {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            max-width: 100%;
            align-items: flex-start;
        }

        .message.user {
            flex-direction: row-reverse;
            margin-left: 2rem;
        }

        .message.bot {
            margin-right: 2rem;
        }

        .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            overflow: hidden;
        }

        .user .avatar {
            background: linear-gradient(135deg, var(--accent-brown), var(--secondary-brown));
            color: white;
            font-weight: 600;
        }

        .bot .avatar {
            background: linear-gradient(135deg, var(--primary-brown), var(--secondary-brown));
            padding: 0;
        }

        .bot .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .message-bubble {
            background: white;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-width: calc(100% - 50px);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .user .message-bubble {
            background: linear-gradient(135deg, var(--primary-brown), var(--secondary-brown));
            color: white;
        }

        .bot .message-bubble {
            background: white;
            color: #333;
        }

        /* Quick Responses - Mobile Optimized */
        .quick-responses {
            padding: 0.5rem 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
        }

        .quick-response {
            background: white;
            border: 2px solid var(--accent-brown);
            color: var(--primary-brown);
            padding: 0.6rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 0 1 auto;
            text-align: center;
            min-width: fit-content;
            max-width: 100%;
        }

        .quick-response:hover,
        .quick-response:active {
            background: var(--accent-brown);
            color: white;
            transform: translateY(-1px);
        }

        /* Input Area - Mobile Optimized */
        .input-area {
            padding: 1rem;
            background: white;
            border-top: 1px solid rgba(139, 69, 19, 0.1);
            position: sticky;
            bottom: 0;
            z-index: 50;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        #userInput {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--accent-brown);
            border-radius: 25px;
            font-size: 1rem;
            background: white;
            resize: none;
            min-height: 45px;
            max-height: 120px;
            line-height: 1.4;
            font-family: inherit;
        }

        #userInput:focus {
            outline: none;
            border-color: var(--secondary-brown);
            box-shadow: 0 0 0 3px rgba(210, 105, 30, 0.1);
        }

        #sendButton {
            background: linear-gradient(135deg, var(--primary-brown), var(--secondary-brown));
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #sendButton:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
        }

        #sendButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 0.5rem 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-brown);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Lyrics Display */
        .lyrics-display {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border: 1px solid var(--accent-brown);
            border-radius: 12px;
            padding: 1rem;
            margin: 0.5rem 0;
            max-width: 100%;
        }

        .lyrics-title {
            font-weight: 600;
            color: var(--primary-brown);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        /* Icons */
        .icon {
            font-size: 1.2rem;
            vertical-align: middle;
        }

        .icon-sm {
            font-size: 1rem;
        }

        /* Mobile Responsiveness Enhancements */
        @media (max-width: 480px) {
            .header {
                padding: 0.75rem 0.5rem;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .header p {
                font-size: 0.8rem;
            }
            
            .chat-messages {
                padding: 0.75rem;
            }
            
            .message.user {
                margin-left: 1rem;
            }
            
            .message.bot {
                margin-right: 1rem;
            }
            
            .avatar {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }
            
            .message-bubble {
                padding: 0.6rem 0.8rem;
                max-width: calc(100% - 42px);
                font-size: 0.9rem;
            }
            
            .quick-response {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
                border-radius: 18px;
            }
            
            .input-area {
                padding: 0.75rem;
            }
            
            #userInput {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.7rem 0.9rem;
            }
            
            #sendButton {
                width: 42px;
                height: 42px;
                font-size: 1.1rem;
            }
        }

        /* Ultra-small screens */
        @media (max-width: 350px) {
            .message.user {
                margin-left: 0.5rem;
            }
            
            .message.bot {
                margin-right: 0.5rem;
            }
            
            .chat-messages {
                padding: 0.5rem;
            }
        }

        /* Landscape mobile optimization */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 0.5rem;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .header p {
                font-size: 0.75rem;
            }
            
            .chat-container {
                height: calc(100vh - 70px);
            }
            
            .album-progress {
                margin: 0.5rem;
                padding: 0.5rem;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .message-bubble {
                border: 2px solid var(--primary-brown);
            }
            
            .quick-response {
                border-width: 3px;
            }
        }

        /* Touch target optimization */
        @media (pointer: coarse) {
            .quick-response {
                min-height: 44px;
                padding: 0.7rem 1rem;
            }
            
            .breadcrumb-back {
                min-height: 40px;
                padding: 0.6rem 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="ph ph-robot"></i>
                <i class="ph ph-heart"></i>
                Your Lyric Lovebot
            </h1>
            <p>Your words, our music, one unforgettable gift.</p>
        </div>

        <div class="chat-container">
            <!-- Conversation Breadcrumbs -->
            <div class="conversation-breadcrumbs" id="breadcrumbs" style="display: none;">
                <button class="breadcrumb-back" onclick="goBackOneStep()" aria-label="Go back to previous step">
                    <i class="ph ph-arrow-left"></i> Back
                </button>
                <div class="breadcrumb-item">
                    <i class="ph ph-house"></i>
                    <span>Start</span>
                </div>
                <span class="breadcrumb-separator">›</span>
                <div class="breadcrumb-item" id="currentBreadcrumb">
                    <span>Getting Started</span>
                </div>
            </div>

            <!-- Album Progress Indicator -->
            <div class="album-progress" id="albumProgress" style="display: none;">
                <div class="progress-step active" id="step1">1</div>
                <div class="progress-connector" id="connector1"></div>
                <div class="progress-step" id="step2">2</div>
                <div class="progress-connector" id="connector2"></div>
                <div class="progress-step" id="step3">3</div>
                <div class="progress-connector" id="connector3"></div>
                <div class="progress-step" id="step4">4</div>
                <div class="progress-connector" id="connector4"></div>
                <div class="progress-step" id="step5">5</div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here dynamically -->
            </div>

            <!-- Quick Responses -->
            <div class="quick-responses" id="quickResponses" style="display: none;">
                <!-- Quick response buttons will be added here -->
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-group">
                    <div class="input-wrapper">
                        <textarea 
                            id="userInput" 
                            placeholder="Type your answer here..." 
                            rows="1"
                            autocomplete="off"
                            autocorrect="off"
                            autocapitalize="sentences"
                            spellcheck="true"
                        ></textarea>
                    </div>
                    <button id="sendButton" type="button" aria-label="Send message">
                        <i class="ph ph-paper-plane-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const LYRIC_API_URL = 'http://localhost:5001/generate-lyrics';
        
        // Global state
        let currentStep = 0;
        let isWaitingForResponse = false;
        let songData = {
            customerName: '',
            recipient: '',
            occasion: '',
            story: '',
            genre: '',
            mood: '',
            productType: '',
            collectingEmail: false,
            collectingRevisions: false,
            collectingAlbumSongs: false,
            collectingAlbumSongRevisions: false,
            currentAlbumSong: 1,
            albumSongs: []
        };

        // Conversation flow definition
        const conversationFlow = [
            {
                bot: "Hey there! <i class='ph ph-hand-waving icon-sm'></i> I'm Echo, your personal lyric lovebot, and I'm SO excited to help you create something magical today! <i class='ph ph-heart icon-sm'></i>\\n\\nBefore we dive in, what's your name? I'd love to make this personal for you!",
                quickResponses: ["My name is...", "Call me...", "I'm..."],
                validation: (input) => input.trim().length >= 1,
                handler: (input) => {
                    songData.customerName = input.trim();
                    return `Nice to meet you, ${songData.customerName}! <i class='ph ph-smiley icon-sm'></i> I love that name!\\n\\nNow, who is this amazing song going to be for? You can tell me their name, or how they're special to you (like "my mom" or "my best friend Sarah").`;
                }
            },
            {
                bot: "",
                quickResponses: ["My boyfriend", "My girlfriend", "My mom", "My dad", "My best friend", "My partner"],
                validation: (input) => input.trim().length >= 1,
                handler: (input) => {
                    songData.recipient = input.trim();
                    return `Aww, ${songData.recipient}! <i class='ph ph-heart icon-sm'></i> I can already tell this is going to be something really special, ${songData.customerName}.\\n\\nWhat's the occasion for this song? Is it for a birthday, anniversary, graduation, or maybe just because you wanted to show them how much they mean to you?`;
                }
            },
            {
                bot: "",
                quickResponses: ["Birthday", "Anniversary", "Valentine's Day", "Christmas", "Graduation", "Just because", "Wedding"],
                validation: (input) => input.trim().length >= 1,
                handler: (input) => {
                    songData.occasion = input.trim();
                    return `Perfect! <i class='ph ph-check-circle icon-sm'></i> A ${songData.occasion.toLowerCase()} song for ${songData.recipient} - I'm getting goosebumps already!\\n\\nBefore we start crafting your lyrics, I need to know: are you looking for a **single personalized song** ($49.99) or a complete **custom album with 5 songs** ($199.99)?\\n\\nBoth include professional vocals, music production, and custom artwork!`;
                }
            },
            {
                bot: "",
                quickResponses: ["Single Song ($49.99)", "Custom Album ($199.99)", "Tell me more about each"],
                validation: (input) => input.toLowerCase().includes('single') || input.toLowerCase().includes('album') || input.toLowerCase().includes('more'),
                handler: (input) => {
                    if (input.toLowerCase().includes('more')) {
                        return `Great question! <i class='ph ph-info icon-sm'></i>\\n\\n**Single Song ($49.99):**\\n• One personalized song (3-4 minutes)\\n• Professional AI vocals & music\\n• Custom artwork\\n• Your story in one beautiful song\\n\\n**Custom Album ($199.99):**\\n• 5 personalized songs\\n• Each song tells part of your story\\n• Professional vocals & music for all\\n• Custom artwork for the album\\n• Perfect for life stories, relationships, families\\n\\nWhich sounds perfect for ${songData.recipient}?`;
                    }
                    
                    if (input.toLowerCase().includes('single')) {
                        songData.productType = 'single';
                        return `Excellent choice! <i class='ph ph-musical-note icon-sm'></i> A single personalized song is perfect for capturing that one special story or feeling.\\n\\nNow for the fun part - tell me the story you want this song to capture! The more details you share about ${songData.recipient}, your relationship, and what makes them special, the more personal and meaningful your song will be.\\n\\nDon't hold back - share memories, inside jokes, special moments, or anything that makes your heart smile when you think of them! <i class='ph ph-heart icon-sm'></i>`;
                    }
                    
                    if (input.toLowerCase().includes('album')) {
                        songData.productType = 'album';
                        songData.collectingAlbumSongs = true;
                        songData.currentAlbumSong = 1;
                        return `WOW! <i class='ph ph-star icon-sm'></i> A custom album is such an incredible gift! You're going to create something absolutely amazing for ${songData.recipient}.\\n\\nI'll help you create 5 unique songs that tell your complete story together. Each song can have its own theme, mood, and style!\\n\\n**Let's start with Song #1:**\\nWhat story, memory, or feeling do you want the first song to capture? Think about a specific moment, experience, or aspect of your relationship that's really meaningful.`;
                    }
                }
            },
            {
                bot: "",
                quickResponses: ["Share a specific memory", "Talk about their personality", "Describe our relationship", "Tell about a special moment"],
                validation: (input) => input.trim().length >= 10,
                handler: (input) => {
                    if (songData.productType === 'album') {
                        // Handle album song collection
                        if (!songData.albumSongs[songData.currentAlbumSong - 1]) {
                            songData.albumSongs[songData.currentAlbumSong - 1] = {};
                        }
                        songData.albumSongs[songData.currentAlbumSong - 1].story = input.trim();
                        songData.albumSongs[songData.currentAlbumSong - 1].songNumber = songData.currentAlbumSong;
                        
                        return `That's beautiful! <i class='ph ph-heart icon-sm'></i> I can already feel the emotion in Song ${songData.currentAlbumSong}.\\n\\nWhat genre/style would work best for this song? Think about the mood of your story - should it be uplifting pop, soulful R&B, heartfelt acoustic, energetic rock, or classic country?`;
                    } else {
                        // Handle single song
                        songData.story = input.trim();
                        return `This is absolutely beautiful, ${songData.customerName}! <i class='ph ph-sparkles icon-sm'></i> I can already feel the love and emotion in your story.\\n\\nNow, what genre would capture this feeling perfectly? Should this be an uplifting **Pop** song, soulful **R&B**, heartfelt **Acoustic**, energetic **Rock**, or classic **Country**?`;
                    }
                }
            },
            {
                bot: "",
                quickResponses: ["Pop", "R&B", "Acoustic", "Rock", "Country"],
                validation: (input) => ['pop', 'r&b', 'acoustic', 'rock', 'country'].some(genre => input.toLowerCase().includes(genre)),
                handler: (input) => {
                    const genre = input.trim();
                    
                    if (songData.productType === 'album') {
                        songData.albumSongs[songData.currentAlbumSong - 1].genre = genre;
                        return `Perfect choice! <i class='ph ph-musical-note icon-sm'></i> ${genre} will be amazing for Song ${songData.currentAlbumSong}.\\n\\nWhat mood should this song have? Should it be **romantic** and tender, **uplifting** and joyful, **nostalgic** and reflective, or **emotional** and heartfelt?`;
                    } else {
                        songData.genre = genre;
                        return `${genre} is perfect! <i class='ph ph-musical-note icon-sm'></i> That genre will really bring your story to life.\\n\\nFinally, what mood should your song have? Should it be **romantic** and tender, **uplifting** and joyful, **nostalgic** and reflective, or **emotional** and heartfelt?`;
                    }
                }
            },
            {
                bot: "",
                quickResponses: ["Romantic", "Uplifting", "Nostalgic", "Emotional"],
                validation: (input) => ['romantic', 'uplifting', 'nostalgic', 'emotional'].some(mood => input.toLowerCase().includes(mood)),
                handler: (input) => {
                    const mood = input.trim();
                    
                    if (songData.productType === 'album') {
                        songData.albumSongs[songData.currentAlbumSong - 1].mood = mood;
                        
                        if (songData.currentAlbumSong < 5) {
                            songData.currentAlbumSong++;
                            updateAlbumProgress(songData.currentAlbumSong);
                            return `Song ${songData.currentAlbumSong - 1} is going to be incredible! <i class='ph ph-check-circle icon-sm'></i>\\n\\n**Now let's create Song #${songData.currentAlbumSong}:**\\nWhat story, memory, or feeling should this song capture? Remember, each song can be completely different - maybe this one focuses on a different aspect of your relationship or a different time period.`;
                        } else {
                            songData.albumSongs[songData.currentAlbumSong - 1].mood = mood;
                            songData.collectingAlbumSongs = false;
                            songData.story = songData.albumSongs.map((song, index) => 
                                `Song ${index + 1} (${song.genre} - ${song.mood}): ${song.story}`
                            ).join('\\n\\n');
                            
                            return `WOW! <i class='ph ph-star icon-sm'></i> ${songData.customerName}, you've just created the outline for an absolutely incredible 5-song album for ${songData.recipient}! I'm getting chills thinking about how amazing this is going to be.\\n\\nYour album will have:\\n${songData.albumSongs.map((song, i) => `• Song ${i+1}: ${song.genre} (${song.mood})`).join('\\n')}\\n\\nLet me generate a preview of your first song's lyrics so you can see the magic we're about to create! <i class='ph ph-magic-wand icon-sm'></i>`;
                        }
                    } else {
                        songData.mood = mood;
                        return `Perfect! <i class='ph ph-heart icon-sm'></i> ${songData.customerName}, I have everything I need to create something absolutely magical for ${songData.recipient}.\\n\\nI'm about to write a ${mood.toLowerCase()} ${songData.genre.toLowerCase()} song about your beautiful story for their ${songData.occasion.toLowerCase()}. This is going to be incredible!\\n\\nLet me work my magic and create your personalized lyrics... <i class='ph ph-magic-wand icon-sm'></i>`;
                    }
                }
            }
        ];

        // Helper functions
        function getBreadcrumbName(step) {
            const stepNames = [
                'Your Name',
                'Recipient',
                'Occasion',
                'Product Type',
                'Story',
                'Genre',
                'Mood'
            ];
            return stepNames[step] || 'Step ' + (step + 1);
        }

        function updateBreadcrumbs(stepName) {
            const breadcrumbs = document.getElementById('breadcrumbs');
            const currentBreadcrumb = document.getElementById('currentBreadcrumb');
            
            if (currentStep > 0) {
                breadcrumbs.style.display = 'flex';
                currentBreadcrumb.innerHTML = `<span>${stepName}</span>`;
            } else {
                breadcrumbs.style.display = 'none';
            }
        }

        function updateAlbumProgress(currentSong) {
            const albumProgress = document.getElementById('albumProgress');
            
            if (songData.productType && songData.productType.toLowerCase().includes('album') && songData.collectingAlbumSongs) {
                albumProgress.style.display = 'flex';
                
                for (let i = 1; i <= 5; i++) {
                    const step = document.getElementById(`step${i}`);
                    const connector = document.getElementById(`connector${i}`);
                    
                    if (i < currentSong) {
                        step.className = 'progress-step completed';
                        if (connector) connector.className = 'progress-connector completed';
                    } else if (i === currentSong) {
                        step.className = 'progress-step active';
                    } else {
                        step.className = 'progress-step';
                    }
                }
            } else {
                albumProgress.style.display = 'none';
            }
        }

        function goBackOneStep() {
            if (currentStep > 0) {
                currentStep--;
                
                document.getElementById('userInput').value = '';
                
                if (currentStep < conversationFlow.length) {
                    addBotMessage(`Let's go back. ${conversationFlow[currentStep].bot}`);
                    showQuickResponses(conversationFlow[currentStep].quickResponses);
                    updateBreadcrumbs(getBreadcrumbName(currentStep));
                }
            }
        }

        function getValidationSuggestions(step, message) {
            const suggestions = {
                0: ["Tell me your first name", "What should I call you?", "Any name is fine!"],
                1: ["Tell me who this song is for", "Their name or relationship (like 'my mom')", "Example: Sarah, my best friend"],
                2: ["What's the special occasion?", "Example: birthday, anniversary, graduation", "Or just say 'no special occasion'"],
                3: ["Share your story in detail", "Include specific memories", "The more details, the better the song!"],
                4: ["Choose: Pop, R&B, Country, Rock, or Acoustic", "What genre fits your story?", "Not sure? Try Pop!"],
                5: ["Pick a mood: romantic, uplifting, nostalgic, or emotional", "What feeling should the song capture?", "Example: uplifting for a celebration"]
            };
            
            return suggestions[step] || ["Give me more details", "Be more specific", "Share what's important to you"];
        }

        function showErrorWithSuggestion(message, suggestions = []) {
            let errorMsg = `❌ ${message}`;
            
            if (suggestions.length > 0) {
                errorMsg += '\\n\\n💡 Try one of these:';
                suggestions.forEach(suggestion => {
                    errorMsg += `\\n• ${suggestion}`;
                });
            }
            
            addBotMessage(errorMsg);
            
            if (suggestions.length > 0) {
                setTimeout(() => {
                    showQuickResponses(suggestions);
                }, 1000);
            }
        }

        function addBotMessage(message, isLyrics = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            
            if (isLyrics) {
                messageDiv.innerHTML = `
                    <div class="avatar"><img src="echobot.png" alt="Echo Bot"></div>
                    <div class="lyrics-display">
                        <div class="lyrics-title">Your Personalized Lyrics</div>
                        ${message}
                    </div>
                `;
            } else {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message bot';
                typingDiv.innerHTML = `
                    <div class="avatar"><img src="echobot.png" alt="Echo Bot"></div>
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                setTimeout(() => {
                    typingDiv.remove();
                    messageDiv.innerHTML = `
                        <div class="avatar"><img src="echobot.png" alt="Echo Bot"></div>
                        <div class="message-bubble">${message}</div>
                    `;
                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 1500);
                return;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addUserMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            
            const initials = songData.customerName ? 
                songData.customerName.split(' ').map(n => n[0]).join('').toUpperCase() : 
                'YOU';
            
            messageDiv.innerHTML = `
                <div class="avatar">${initials}</div>
                <div class="message-bubble">${message}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showQuickResponses(responses) {
            const quickResponsesDiv = document.getElementById('quickResponses');
            
            if (!responses || responses.length === 0) {
                quickResponsesDiv.style.display = 'none';
                return;
            }
            
            quickResponsesDiv.innerHTML = '';
            responses.forEach(response => {
                const button = document.createElement('button');
                button.className = 'quick-response';
                button.textContent = response;
                button.onclick = () => selectQuickResponse(response);
                quickResponsesDiv.appendChild(button);
            });
            
            quickResponsesDiv.style.display = 'flex';
        }

        function selectQuickResponse(response) {
            document.getElementById('userInput').value = response;
            sendMessage();
        }

        function hideQuickResponses() {
            document.getElementById('quickResponses').style.display = 'none';
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message || isWaitingForResponse) return;
            
            hideQuickResponses();
            
            // Handle special cases first
            if (songData.collectingEmail) {
                const emailPattern = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;
                if (!emailPattern.test(message)) {
                    showErrorWithSuggestion(
                        "That doesn't look like a valid email address.", 
                        [
                            "Make sure it includes @ and a domain (like gmail.com)",
                            "Example: yourname@gmail.com",
                            "Double-check for typos"
                        ]
                    );
                    return;
                }
                
                addUserMessage(message);
                input.value = '';
                songData.collectingEmail = false;
                input.placeholder = 'Type your answer here...';
                
                await createOrderWithEmail(message);
                return;
            }
            
            if (songData.collectingRevisions) {
                addUserMessage(message);
                input.value = '';
                songData.collectingRevisions = false;
                input.placeholder = 'Type your answer here...';
                
                addBotMessage(`Perfect! <i class='ph ph-magic-wand icon-sm'></i> Let me regenerate your lyrics with these changes. This is going to be even more amazing!`);
                
                setTimeout(() => {
                    songData.revisionRequest = message;
                    generateLyrics();
                }, 2000);
                return;
            }
            
            if (songData.collectingAlbumSongRevisions) {
                addUserMessage(message);
                input.value = '';
                songData.collectingAlbumSongRevisions = false;
                input.placeholder = 'Type your answer here...';
                
                addBotMessage(`Excellent feedback! <i class='ph ph-magic-wand icon-sm'></i> Let me regenerate Song ${songData.currentAlbumSong} with your suggestions. The revised version is going to be incredible!`);
                
                setTimeout(() => {
                    songData.revisionRequest = message;
                    generateLyrics();
                }, 2000);
                return;
            }
            
            if (songData.collectingAlbumSongs && songData.currentAlbumSong <= 5) {
                addUserMessage(message);
                input.value = '';
                
                const currentFlow = conversationFlow[currentStep];
                if (currentFlow && currentFlow.handler) {
                    const response = currentFlow.handler(message);
                    addBotMessage(response);
                    
                    if (songData.currentAlbumSong <= 5) {
                        const nextFlow = conversationFlow[currentStep + 1];
                        if (nextFlow) {
                            showQuickResponses(nextFlow.quickResponses);
                        }
                    } else {
                        setTimeout(() => {
                            generateLyrics();
                        }, 3000);
                    }
                }
                return;
            }
            
            const currentFlow = conversationFlow[currentStep];
            
            if (!currentFlow.validation(message)) {
                const suggestions = getValidationSuggestions(currentStep, message);
                showErrorWithSuggestion("Hmm, could you tell me a bit more? I want to make sure I capture this perfectly!", suggestions);
                return;
            }
            
            addUserMessage(message);
            input.value = '';
            
            if (currentFlow.handler) {
                const response = currentFlow.handler(message);
                addBotMessage(response);
                
                currentStep++;
                
                if (currentStep < conversationFlow.length) {
                    updateBreadcrumbs(getBreadcrumbName(currentStep));
                    
                    setTimeout(() => {
                        showQuickResponses(conversationFlow[currentStep].quickResponses);
                    }, 1500);
                } else {
                    setTimeout(() => {
                        generateLyrics();
                    }, 2000);
                }
            }
        }

        async function generateLyrics() {
            isWaitingForResponse = true;
            hideQuickResponses();
            
            const requestData = {
                recipient: songData.recipient,
                occasion: songData.occasion,
                story: songData.story,
                genre: songData.productType === 'album' && songData.albumSongs.length > 0 ? 
                    songData.albumSongs[0].genre : songData.genre,
                mood: songData.productType === 'album' && songData.albumSongs.length > 0 ? 
                    songData.albumSongs[0].mood : songData.mood,
                customer_email: 'from_website',
                revisionRequest: songData.revisionRequest || null
            };
            
            try {
                const response = await fetch(LYRIC_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const formattedLyrics = data.lyrics.replace(/\\n/g, '<br>');
                    addBotMessage(formattedLyrics, true);
                    
                    setTimeout(() => {
                        addBotMessage(`${songData.customerName}, this is just the beginning! <i class='ph ph-sparkles icon-sm'></i>\\n\\nWhat you're seeing is your personalized lyrics preview. Here's what happens next:\\n\\n🎤 **Professional vocals** - We'll have this sung beautifully\\n🎵 **Music production** - Full instrumental backing\\n🎨 **Custom artwork** - Designed to match your song\\n📧 **Delivery** - Complete package sent to you in 48 hours\\n\\nTo make this real for ${songData.recipient}, I just need your email address and we can get started on production!`);
                        
                        songData.collectingEmail = true;
                        document.getElementById('userInput').placeholder = 'Enter your email address...';
                        isWaitingForResponse = false;
                        document.getElementById('userInput').disabled = false;
                        document.getElementById('sendButton').disabled = false;
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Failed to generate lyrics');
                }
                
            } catch (error) {
                console.error('Error generating lyrics:', error);
                addBotMessage(`I'm having a little trouble connecting to my creative engine right now. <i class='ph ph-warning icon-sm'></i> But don't worry! Let me collect your information and I'll make sure you get an amazing song.\\n\\nWhat's your email address so I can send you updates and your completed song?`);
                
                songData.collectingEmail = true;
                document.getElementById('userInput').placeholder = 'Enter your email address...';
                isWaitingForResponse = false;
                document.getElementById('userInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
            }
        }

        async function createOrderWithEmail(email) {
            addBotMessage(`Perfect! <i class='ph ph-check-circle icon-sm'></i> I've got your email: ${email}\\n\\nNow I'm creating your order and setting up payment. One moment please...`);
            
            const orderData = {
                'Customer Email': email,
                'Recipient Name': songData.recipient,
                'Occasion': songData.occasion,
                'Genre': songData.productType === 'album' ? 'Album (Multiple Genres)' : songData.genre,
                'Mood': songData.productType === 'album' ? 'Album (Multiple Moods)' : songData.mood,
                'Story & Themes': songData.story,
                'Product Type': songData.productType === 'album' ? 'Custom Album ($199.99)' : 'Single Song ($49.99)',
                'Order Date': new Date().toLocaleDateString(),
                'Order Source': 'echogifts.shop/echo-bot',
                'Customer Name': songData.customerName
            };
            
            if (songData.productType === 'album') {
                songData.albumSongs.forEach((song, index) => {
                    orderData[`Song ${index + 1} Genre`] = song.genre;
                    orderData[`Song ${index + 1} Mood`] = song.mood;
                    orderData[`Song ${index + 1} Story`] = song.story;
                });
            }
            
            try {
                const formspreeResponse = await fetch('https://formspree.io/f/xkgzqpyy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        _subject: `🤖 NEW ORDER from Echo Bot - ${songData.customerName} (${songData.productType})`,
                        ...orderData
                    })
                });
                
                if (formspreeResponse.ok) {
                    console.log('Order sent to Formspree successfully');
                }
            } catch (error) {
                console.error('Error sending to Formspree:', error);
            }
            
            setTimeout(() => {
                const price = songData.productType === 'album' ? '$199.99' : '$49.99';
                const productName = songData.productType === 'album' ? 'Custom 5-Song Album' : 'Personalized Song';
                
                addBotMessage(`Excellent! <i class='ph ph-check-circle icon-sm'></i> Your order is ready, ${songData.customerName}!\\n\\n**Order Summary:**\\n• ${productName} for ${songData.recipient}\\n• ${songData.occasion} occasion\\n• ${price} total\\n• Delivery to: ${email}\\n\\nReady to make this magical song a reality? Let's complete your order!`);
                
                setTimeout(() => {
                    createStripeCheckout(email, orderData);
                }, 1500);
            }, 2000);
        }

        function createStripeCheckout(email, orderData) {
            const productType = songData.productType;
            const checkoutUrl = productType === 'album' ? 
                'https://buy.stripe.com/cNi5kDe5eccXefSdBW97G05' : 
                'https://buy.stripe.com/14A8wPd1a7WHfjW69u97G04';
            
            sessionStorage.setItem('echogifts_order', JSON.stringify({
                ...orderData,
                'Order ID': 'EG-' + Date.now(),
                'Payment Status': 'Pending'
            }));
            
            const checkoutButton = document.createElement('div');
            checkoutButton.style.cssText = `
                margin: 1rem 0;
                text-align: center;
                padding: 1rem;
                background: linear-gradient(135deg, #f8f9fa, #ffffff);
                border-radius: 12px;
                border: 2px solid var(--accent-brown);
            `;
            
            const price = productType === 'album' ? '$199.99' : '$49.99';
            checkoutButton.innerHTML = `
                <div style="margin-bottom: 1rem; color: var(--primary-brown); font-weight: 600;">
                    <i class="ph ph-credit-card" style="margin-right: 0.5rem;"></i>
                    Secure Checkout - ${price}
                </div>
                <button onclick="window.open('${checkoutUrl}?prefilled_email=${encodeURIComponent(email)}', '_blank')" 
                        style="background: linear-gradient(135deg, var(--primary-brown), var(--secondary-brown)); 
                               color: white; 
                               border: none; 
                               padding: 1rem 2rem; 
                               border-radius: 25px; 
                               font-size: 1.1rem; 
                               font-weight: 600; 
                               cursor: pointer; 
                               transition: all 0.2s ease;
                               width: 100%;
                               max-width: 300px;">
                    Complete Purchase ${price}
                </button>
                <div style="margin-top: 0.75rem; font-size: 0.8rem; color: #666;">
                    <i class="ph ph-lock" style="margin-right: 0.25rem;"></i>
                    Secure payment powered by Stripe
                </div>
            `;
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(checkoutButton);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            const productText = productType === 'album' ? 'album' : 'song';
            setTimeout(() => {
                addBotMessage(`<i class='ph ph-check-circle icon-sm'></i> Payment page opened! Complete your purchase there, ${songData.customerName}, and we'll get started on your ${productText} immediately.\\n\\nIf you have any questions, email us at hello@echogifts.shop. Thank you for choosing EchoGifts! <i class='ph ph-heart icon-sm'></i>`);
            }, 1000);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            
            // Auto-resize textarea
            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // Send message on Enter (but allow Shift+Enter for new lines)
            userInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey && !isWaitingForResponse) {
                    event.preventDefault();
                    sendMessage();
                }
            });
            
            sendButton.addEventListener('click', sendMessage);
            
            // Start conversation
            setTimeout(() => {
                addBotMessage(conversationFlow[0].bot);
                showQuickResponses(conversationFlow[0].quickResponses);
            }, 1000);
            
            // Analytics tracking
            gtag('event', 'page_view', {
                page_title: 'Echo Bot Conversation Started',
                page_location: window.location.href,
                custom_parameter_1: 'echo_bot_launch'
            });
        });

        // Prevent zoom on iOS
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>